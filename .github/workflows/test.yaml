---
name: test

# Actions for any push (PR) onto (into) to master

# -----------------
# Control variables (GitHub Secrets)
# -----------------
#
# At the GitHub 'organisation' or 'project' level you must have the following
# GitHub 'Repository Secrets' defined (i.e. via 'Settings -> Secrets'): -
#
# AUTH0_CLIENT_ID
# AUTH0_CLIENT_SECRET
# DMIT_USER_A_PASSWORD
# DMIT_USER_A_PASSWORD
#
# -----------
# Environment (GitHub Environments)
# -----------
#
# Environment         (n/a)

on:
  push:

jobs:
  test-base-path:
    # Setup
    runs-on: ubuntu-latest
    environment: data-manager-ui/test
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - uses: pnpm/action-setup@v2.2.2
      with:
        version: 6.32.25
        run_install: false
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 16
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
    - run: node -v
    - name: Setup Playwright
      run: pnpm exec playwright install --with-deps
    - name: Load cached build for speed
      uses: actions/cache@v2
      with:
        path: |
          ${{ github.workspace }}/.next/cache
        # Generate a new cache whenever packages or source files change.
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
        # If source files changed but packages didn't, rebuild from a prior cache.
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
    # Test WITH base path set
    - name: Build with base path
      run: pnpm build
      env:
        BASE_PATH: "/data-manager-ui"
    - name: Test with base path
      env:
        AUTH0_CLIENT_ID: "${{ secrets.AUTH0_CLIENT_ID }}"
        AUTH0_CLIENT_SECRET: "${{ secrets.AUTH0_CLIENT_SECRET }}"
        DMIT_USER_A_PASSWORD: "${{ secrets.DMIT_USER_A_PASSWORD }}"
        AUTH0_SECRET: "LONG_RANDOM_VALUE"
        BASE_URL: "http://localhost:3000"
        BASE_PATH: "/data-manager-ui"
        DATA_MANAGER_API_SERVER: "https://data-manager.xchem-dev.diamond.ac.uk/data-manager-api"
        ACCOUNT_SERVER_API_SERVER: "https://account-server.xchem-dev.diamond.ac.uk/account-server-api"
        KEYCLOAK_URL: "https://keycloak.xchem-dev.diamond.ac.uk/auth/realms/xchem"
        PW_USERNAME: "dmit-user-a"
        PW_PASSWORD: "${{ secrets.DMIT_USER_A_PASSWORD }}"
        TEST_PORT: 3000
      run: pnpm test:ci
    - name: Upload results for bath path
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: Base Path Results
        path: test-results
  test-no-base-path:
    # Setup
    runs-on: ubuntu-latest
    environment: data-manager-ui/test
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - uses: pnpm/action-setup@v2.2.2
      with:
        version: 6.32.25
        run_install: false
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 16
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
    - run: node -v
    - name: Setup Playwright
      run: pnpm exec playwright install --with-deps
    - name: Load cached build for speed
      uses: actions/cache@v2
      with:
        path: |
          ${{ github.workspace }}/.next/cache
        # Generate a new cache whenever packages or source files change.
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
        # If source files changed but packages didn't, rebuild from a prior cache.
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
    # Test withOUT base path set
    - name: Build without base path
      run: pnpm build
      env:
        BASE_PATH: ""
    - name: Test without base path
      env:
        AUTH0_CLIENT_ID: "${{ secrets.AUTH0_CLIENT_ID }}"
        AUTH0_CLIENT_SECRET: "${{ secrets.AUTH0_CLIENT_SECRET }}"
        DMIT_USER_A_PASSWORD: "${{ secrets.DMIT_USER_A_PASSWORD }}"
        AUTH0_SECRET: "LONG_RANDOM_VALUE"
        BASE_URL: "http://localhost:3000"
        BASE_PATH: ""
        DATA_MANAGER_API_SERVER: "https://data-manager.xchem-dev.diamond.ac.uk/data-manager-api"
        ACCOUNT_SERVER_API_SERVER: "https://account-server.xchem-dev.diamond.ac.uk/account-server-api"
        KEYCLOAK_URL: "https://keycloak.xchem-dev.diamond.ac.uk/auth/realms/xchem"
        PW_USERNAME: "dmit-user-a"
        PW_PASSWORD: "${{ secrets.DMIT_USER_A_PASSWORD }}"
        TEST_PORT: 3000
      run: pnpm test:ci
    - name: Upload results for no bath path
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: No Base Path Results
        path: test-results
